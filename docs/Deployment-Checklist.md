# Laravel 統一 API Server 部署檢查清單

## 部署前檢查

### 環境準備

- [ ] 確認 Docker 和 Docker Compose 已安裝
- [ ] 確認 `.env` 檔案已正確配置
- [ ] 確認 `docker-compose.prod.yml` 檔案存在
- [ ] 確認所有必要的埠號未被佔用 (80, 443, 3306, 6379)
- [ ] 確認磁碟空間充足 (至少 10GB 可用空間)

### 代碼檢查

- [ ] 確認代碼已提交到版本控制系統
- [ ] 確認所有測試通過
- [ ] 確認沒有除錯代碼或敏感資訊
- [ ] 確認 `composer.lock` 檔案已更新
- [ ] 確認資料庫遷移檔案已準備

### 配置檢查

- [ ] 檢查 `APP_ENV=production`
- [ ] 檢查 `APP_DEBUG=false`
- [ ] 檢查資料庫連線設定
- [ ] 檢查 Redis 連線設定
- [ ] 檢查 SSL 憑證配置
- [ ] 檢查日誌配置

## 部署執行

### 備份現有系統

- [ ] 執行資料庫備份
  ```bash
  ./scripts/deploy.sh backup
  ```
- [ ] 備份上傳檔案
- [ ] 記錄當前版本資訊

### 部署新版本

- [ ] 拉取最新代碼
  ```bash
  git pull origin main
  ```
- [ ] 執行部署腳本
  ```bash
  ./scripts/deploy.sh deploy
  ```
- [ ] 監控部署過程輸出

### 服務啟動檢查

- [ ] 確認所有容器正常啟動
  ```bash
  docker-compose -f docker-compose.prod.yml ps
  ```
- [ ] 檢查容器日誌無錯誤
  ```bash
  docker-compose -f docker-compose.prod.yml logs
  ```

## 部署後驗證

### 基本功能測試

- [ ] 檢查 API 健康狀態
  ```bash
  curl -s http://localhost/api/health | jq .
  ```
- [ ] 檢查詳細健康狀態
  ```bash
  curl -s http://localhost/api/health/detailed | jq .
  ```
- [ ] 測試 API 文件頁面
  ```bash
  curl -s http://localhost/api/docs/
  ```

### 資料庫連線測試

- [ ] 確認資料庫連線正常
- [ ] 確認資料庫遷移已執行
- [ ] 檢查資料完整性

### 快取系統測試

- [ ] 確認 Redis 連線正常
- [ ] 測試快取讀寫功能
- [ ] 清除舊快取資料

### API 功能測試

- [ ] 測試 Bearer Token 驗證
- [ ] 測試基本 API 端點
- [ ] 測試錯誤處理
- [ ] 測試回應格式

### 效能測試

- [ ] 檢查 API 回應時間
- [ ] 檢查系統資源使用率
- [ ] 執行負載測試 (如需要)

### 安全檢查

- [ ] 確認 HTTPS 正常運作
- [ ] 檢查防火牆規則
- [ ] 驗證 Token 安全性
- [ ] 檢查敏感資訊是否洩漏

## 監控設定

### 日誌監控

- [ ] 確認日誌檔案正常生成
- [ ] 設定日誌輪轉
- [ ] 配置日誌警報

### 系統監控

- [ ] 設定健康檢查監控
- [ ] 配置資源使用監控
- [ ] 設定服務可用性監控

### 警報配置

- [ ] 配置郵件警報
- [ ] 配置 Slack 通知 (如適用)
- [ ] 測試警報功能

## 文件更新

### 部署記錄

- [ ] 記錄部署時間和版本
- [ ] 記錄部署人員
- [ ] 記錄任何特殊操作

### 文件維護

- [ ] 更新 API 文件
- [ ] 更新維護文件
- [ ] 更新故障排除指南

## 回滾準備

### 回滾計劃

- [ ] 準備回滾腳本
- [ ] 確認備份可用性
- [ ] 制定回滾決策標準

### 回滾測試

- [ ] 在測試環境驗證回滾程序
- [ ] 確認回滾時間估算
- [ ] 準備回滾通知模板

## 部署完成確認

### 最終檢查

- [ ] 所有服務正常運行
- [ ] API 功能完全正常
- [ ] 監控系統正常工作
- [ ] 備份系統正常運行

### 通知相關人員

- [ ] 通知開發團隊部署完成
- [ ] 通知使用者 (如有重大更新)
- [ ] 更新狀態頁面 (如適用)

### 部署後監控

- [ ] 持續監控系統狀態 24 小時
- [ ] 檢查錯誤日誌
- [ ] 監控效能指標
- [ ] 收集使用者回饋

## 緊急程序

### 部署失敗處理

如果部署過程中出現問題：

1. **立即停止部署**
   ```bash
   docker-compose -f docker-compose.prod.yml down
   ```

2. **評估問題嚴重性**
   - 檢查錯誤日誌
   - 確認影響範圍

3. **決定處理方式**
   - 修復問題繼續部署
   - 或執行回滾程序

### 回滾程序

如果需要回滾到前一版本：

1. **執行回滾**
   ```bash
   git reset --hard HEAD~1
   ./scripts/deploy.sh deploy
   ```

2. **恢復資料庫** (如需要)
   ```bash
   # 使用備份恢復資料庫
   ```

3. **驗證回滾結果**
   - 檢查服務狀態
   - 測試基本功能

## 檢查清單簽核

### 部署執行人員

- **姓名**：________________
- **日期**：________________
- **簽名**：________________

### 技術審核人員

- **姓名**：________________
- **日期**：________________
- **簽名**：________________

### 專案負責人

- **姓名**：________________
- **日期**：________________
- **簽名**：________________

---

**注意事項**：

1. 此檢查清單應在每次部署時完整執行
2. 任何跳過的項目都應記錄原因
3. 部署完成後應保留此檢查清單作為記錄
4. 定期檢討和更新此檢查清單內容