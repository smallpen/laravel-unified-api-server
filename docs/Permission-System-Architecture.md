# 權限系統架構文檔

## 系統架構概覽

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              權限系統架構                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │   HTTP Request  │    │  Bearer Token   │    │  API Response   │             │
│  │                 │───▶│   Middleware    │───▶│                 │             │
│  │ Authorization:  │    │                 │    │ Success/Error   │             │
│  │ Bearer TOKEN    │    └─────────────────┘    └─────────────────┘             │
│  └─────────────────┘             │                                              │
│                                  │                                              │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        TokenService                                     │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐              ┌─────────────────┐                  │   │
│  │  │ TokenValidator  │              │ TokenManager    │                  │   │
│  │  │                 │              │                 │                  │   │
│  │  │ • validate()    │              │ • createToken() │                  │   │
│  │  │ • isExpired()   │              │ • revokeToken() │                  │   │
│  │  │ • hasPermission()│              │ • getUserTokens()│                  │   │
│  │  └─────────────────┘              └─────────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                  │                                              │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    UnifiedApiController                                 │   │
│  │                                                                         │   │
│  │  1. 驗證請求方法 (POST only)                                             │   │
│  │  2. 驗證必要參數 (action_type)                                           │   │
│  │  3. 路由到對應 Action                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                  │                                              │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    PermissionChecker                                    │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │   │
│  │  │ canExecuteAction│    │userHasPermissions│    │getUserPermissions│     │   │
│  │  │                 │    │                 │    │                 │     │   │
│  │  │ • 檢查Action啟用 │    │ • 權限匹配檢查   │    │ • 取得使用者權限 │     │   │
│  │  │ • 取得權限要求   │    │ • 逐一驗證權限   │    │ • Token/User權限 │     │   │
│  │  │ • 呼叫權限檢查   │    │ • 記錄檢查結果   │    │ • 管理員權限邏輯 │     │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                  │                                              │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      ActionRegistry                                     │   │
│  │                                                                         │   │
│  │  • resolve(actionType) → ActionInterface                               │   │
│  │  • hasAction(actionType) → bool                                        │   │
│  │  • autoDiscoverActions()                                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                  │                                              │
│                                  ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      Action Execution                                   │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │   │
│  │  │   BaseAction    │    │ GetServerStatus │    │  Other Actions  │     │   │
│  │  │                 │    │     Action      │    │                 │     │   │
│  │  │ • validate()    │    │                 │    │ • UserActions   │     │   │
│  │  │ • getVersion()  │    │ • execute()     │    │ • SystemActions │     │   │
│  │  │ • isEnabled()   │    │ • getRequired   │    │ • AdminActions  │     │   │
│  │  │ • getRequired   │    │   Permissions() │    │                 │     │   │
│  │  │   Permissions() │    └─────────────────┘    └─────────────────┘     │   │
│  │  └─────────────────┘                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 資料模型關係

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              資料模型關係圖                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                    ┌─────────────────┐                    │
│  │      User       │                    │    ApiToken     │                    │
│  │                 │                    │                 │                    │
│  │ • id            │◄──────────────────►│ • id            │                    │
│  │ • name          │        1:N         │ • user_id       │                    │
│  │ • email         │                    │ • token_hash    │                    │
│  │ • permissions   │                    │ • name          │                    │
│  │   (JSON Array)  │                    │ • permissions   │                    │
│  │ • is_admin      │                    │   (JSON Array)  │                    │
│  │ • created_at    │                    │ • expires_at    │                    │
│  │ • updated_at    │                    │ • last_used_at  │                    │
│  └─────────────────┘                    │ • is_active     │                    │
│                                         │ • created_at    │                    │
│                                         │ • updated_at    │                    │
│                                         └─────────────────┘                    │
│                                                                                 │
│                                                                                 │
│  ┌─────────────────┐                    ┌─────────────────┐                    │
│  │ ActionPermission│                    │   Action Class  │                    │
│  │                 │                    │   (Interface)   │                    │
│  │ • id            │                    │                 │                    │
│  │ • action_type   │◄──────────────────►│ • getActionType()│                   │
│  │ • required_     │      關聯查詢       │ • getRequired   │                    │
│  │   permissions   │                    │   Permissions() │                    │
│  │   (JSON Array)  │                    │ • execute()     │                    │
│  │ • is_active     │                    │ • validate()    │                    │
│  │ • description   │                    │ • isEnabled()   │                    │
│  │ • created_at    │                    │ • getVersion()  │                    │
│  │ • updated_at    │                    └─────────────────┘                    │
│  └─────────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 權限檢查流程圖

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            權限檢查詳細流程                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │   API Request   │                                                           │
│  │ with Bearer     │                                                           │
│  │     Token       │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ BearerToken     │ NO  │   Return 401    │                                  │
│  │ Middleware      │────▶│   Unauthorized  │                                  │
│  │ Token Valid?    │     └─────────────────┘                                  │
│  └─────────┬───────┘                                                           │
│            │ YES                                                               │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ TokenValidator  │                                                           │
│  │ validate()      │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ Token has       │ YES │ user.permissions│                                  │
│  │ permissions?    │────▶│ = token.        │                                  │
│  └─────────┬───────┘     │   permissions   │                                  │
│            │ NO          └─────────────────┘                                  │
│            │                       │                                          │
│            │                       │                                          │
│            ▼                       │                                          │
│  ┌─────────────────┐               │                                          │
│  │ Keep original   │               │                                          │
│  │ user.permissions│               │                                          │
│  └─────────┬───────┘               │                                          │
│            │                       │                                          │
│            └───────────────────────┘                                          │
│                            │                                                   │
│                            ▼                                                   │
│  ┌─────────────────┐                                                           │
│  │UnifiedApiController│                                                        │
│  │ routeToAction() │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ ActionRegistry  │ NO  │   Return 404    │                                  │
│  │ hasAction()?    │────▶│ ACTION_NOT_FOUND│                                  │
│  └─────────┬───────┘     └─────────────────┘                                  │
│            │ YES                                                               │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ Action          │ NO  │   Return 403    │                                  │
│  │ isEnabled()?    │────▶│ ACTION_DISABLED │                                  │
│  └─────────┬───────┘     └─────────────────┘                                  │
│            │ YES                                                               │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │PermissionChecker│                                                           │
│  │canExecuteAction()│                                                          │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ Get Action      │     │ ActionPermission│                                  │
│  │ Required        │────▶│ .findByActionType│                                 │
│  │ Permissions     │     │ (actionType)    │                                  │
│  └─────────┬───────┘     └─────────┬───────┘                                  │
│            │                       │                                          │
│            ▼                       ▼                                          │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ Database Config │     │ Action Default  │                                  │
│  │ Found?          │     │ getRequired     │                                  │
│  │                 │     │ Permissions()   │                                  │
│  └─────────┬───────┘     └─────────┬───────┘                                  │
│            │ YES                   │ NO                                       │
│            │                       │                                          │
│            └───────────────────────┘                                          │
│                            │                                                   │
│                            ▼                                                   │
│  ┌─────────────────┐                                                           │
│  │ userHasPermissions│                                                         │
│  │ (user, required)│                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐                                  │
│  │ Check each      │ NO  │   Return 403    │                                  │
│  │ required        │────▶│ INSUFFICIENT_   │                                  │
│  │ permission      │     │ PERMISSIONS     │                                  │
│  └─────────┬───────┘     └─────────────────┘                                  │
│            │ YES                                                               │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ Execute Action  │                                                           │
│  │ action.execute()│                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ Return Success  │                                                           │
│  │ Response        │                                                           │
│  └─────────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 權限層級決策樹

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            權限決策樹                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                          ┌─────────────────┐                                   │
│                          │   API Request   │                                   │
│                          │  with Token     │                                   │
│                          └─────────┬───────┘                                   │
│                                    │                                           │
│                                    ▼                                           │
│                          ┌─────────────────┐                                   │
│                          │ Token has       │                                   │
│                          │ permissions?    │                                   │
│                          └─────────┬───────┘                                   │
│                                    │                                           │
│                    ┌───────────────┼───────────────┐                           │
│                    │ YES           │               │ NO                        │
│                    ▼               ▼               ▼                           │
│          ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │
│          │ Use Token       │ │ Token.permissions│ │ Use User Base   │           │
│          │ Permissions     │ │ = []            │ │ Permissions     │           │
│          │                 │ │ (Empty Array)   │ │                 │           │
│          └─────────┬───────┘ └─────────┬───────┘ └─────────┬───────┘           │
│                    │                   │                   │                   │
│                    │                   │                   │                   │
│                    ▼                   ▼                   ▼                   │
│          ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │
│          │ Effective       │ │ Effective       │ │ Effective       │           │
│          │ Permissions =   │ │ Permissions =   │ │ Permissions =   │           │
│          │ Token.permissions│ │ User.permissions│ │ User.permissions│           │
│          └─────────┬───────┘ └─────────┬───────┘ └─────────┬───────┘           │
│                    │                   │                   │                   │
│                    └───────────────────┼───────────────────┘                   │
│                                        │                                       │
│                                        ▼                                       │
│                              ┌─────────────────┐                               │
│                              │ Get Action      │                               │
│                              │ Required        │                               │
│                              │ Permissions     │                               │
│                              └─────────┬───────┘                               │
│                                        │                                       │
│                        ┌───────────────┼───────────────┐                       │
│                        │               │               │                       │
│                        ▼               ▼               ▼                       │
│              ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │
│              │ Database Config │ │ Action Default  │ │ No Requirements │       │
│              │ (Priority 1)    │ │ (Priority 2)    │ │ (Allow Access)  │       │
│              └─────────┬───────┘ └─────────┬───────┘ └─────────┬───────┘       │
│                        │                   │                   │               │
│                        └───────────────────┼───────────────────┘               │
│                                            │                                   │
│                                            ▼                                   │
│                                  ┌─────────────────┐                           │
│                                  │ Permission      │                           │
│                                  │ Matching Check  │                           │
│                                  └─────────┬───────┘                           │
│                                            │                                   │
│                            ┌───────────────┼───────────────┐                   │
│                            │ MATCH         │               │ NO MATCH          │
│                            ▼               ▼               ▼                   │
│                  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│                  │ ✅ Allow        │ │ ❌ Deny         │ │ ❌ Deny         │   │
│                  │ Execute Action  │ │ Return 403      │ │ Return 403      │   │
│                  │                 │ │ INSUFFICIENT_   │ │ INSUFFICIENT_   │   │
│                  │                 │ │ PERMISSIONS     │ │ PERMISSIONS     │   │
│                  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 服務依賴關係

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            服務依賴關係圖                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │ Laravel Service │                                                           │
│  │   Container     │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    Service Providers                                    │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │ ActionService   │  │ TokenService    │  │ PermissionService│         │   │
│  │  │ Provider        │  │ Provider        │  │ Provider        │         │   │
│  │  │                 │  │                 │  │                 │         │   │
│  │  │ • ActionRegistry│  │ • TokenService  │  │ • PermissionChecker│       │   │
│  │  │ • Auto Discovery│  │ • TokenValidator│  │ • ResponseFormatter│       │   │
│  │  └─────────────────┘  │ • TokenManager  │  └─────────────────┘         │   │
│  │                       └─────────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Core Services                                    │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐              ┌─────────────────┐                  │   │
│  │  │ ActionRegistry  │              │ PermissionChecker│                  │   │
│  │  │                 │              │                 │                  │   │
│  │  │ Dependencies:   │              │ Dependencies:   │                  │   │
│  │  │ • File System  │              │ • ActionPermission│                 │   │
│  │  │ • Reflection   │              │ • User Model    │                  │   │
│  │  │ • Event System │              │ • Log System    │                  │   │
│  │  └─────────────────┘              └─────────────────┘                  │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐              ┌─────────────────┐                  │   │
│  │  │ TokenService    │              │ ResponseFormatter│                  │   │
│  │  │                 │              │                 │                  │   │
│  │  │ Dependencies:   │              │ Dependencies:   │                  │   │
│  │  │ • TokenValidator│              │ • None (Pure)   │                  │   │
│  │  │ • TokenManager  │              │                 │                  │   │
│  │  │ • ApiToken Model│              │                 │                  │   │
│  │  └─────────────────┘              └─────────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Data Models                                      │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │     User        │  │    ApiToken     │  │ ActionPermission│         │   │
│  │  │                 │  │                 │  │                 │         │   │
│  │  │ • permissions   │  │ • token_hash    │  │ • action_type   │         │   │
│  │  │ • is_admin      │  │ • permissions   │  │ • required_     │         │   │
│  │  │                 │  │ • expires_at    │  │   permissions   │         │   │
│  │  │                 │  │ • is_active     │  │ • is_active     │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        External Dependencies                            │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │    Database     │  │   File System   │  │   Log System    │         │   │
│  │  │                 │  │                 │  │                 │         │   │
│  │  │ • MySQL/SQLite  │  │ • Action Files  │  │ • Laravel Log   │         │   │
│  │  │ • Migrations    │  │ • Auto Discovery│  │ • Permission    │         │   │
│  │  │ • Eloquent ORM  │  │                 │  │   Audit Trail   │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 配置和初始化流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        應用程式啟動和初始化流程                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │ Laravel Boot    │                                                           │
│  │ Process         │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ Load Service    │                                                           │
│  │ Providers       │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐           │
│  │ ActionService   │     │ TokenService    │     │ PermissionService│           │
│  │ Provider        │     │ Provider        │     │ Provider        │           │
│  │                 │     │                 │     │                 │           │
│  │ register():     │     │ register():     │     │ register():     │           │
│  │ • ActionRegistry│     │ • TokenService  │     │ • PermissionChecker│         │
│  │   (Singleton)   │     │ • TokenValidator│     │ • ResponseFormatter│         │
│  │                 │     │ • TokenManager  │     │   (Singleton)   │           │
│  └─────────┬───────┘     └─────────┬───────┘     └─────────┬───────┘           │
│            │                       │                       │                   │
│            ▼                       ▼                       ▼                   │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐           │
│  │ boot():         │     │ boot():         │     │ boot():         │           │
│  │ • Auto Discover │     │ • No boot       │     │ • No boot       │           │
│  │   Actions       │     │   actions       │     │   actions       │           │
│  │ • Scan app/     │     │                 │     │                 │           │
│  │   Actions/      │     │                 │     │                 │           │
│  │ • Register      │     │                 │     │                 │           │
│  │   found Actions │     │                 │     │                 │           │
│  └─────────┬───────┘     └─────────────────┘     └─────────────────┘           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ Action Auto     │                                                           │
│  │ Discovery       │                                                           │
│  │                 │                                                           │
│  │ 1. Scan Files   │                                                           │
│  │ 2. Check Class  │                                                           │
│  │ 3. Validate     │                                                           │
│  │    Interface    │                                                           │
│  │ 4. Register     │                                                           │
│  │    Action       │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ System Ready    │                                                           │
│  │ for API         │                                                           │
│  │ Requests        │                                                           │
│  └─────────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 錯誤處理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            錯誤處理流程圖                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │   Exception     │                                                           │
│  │   Occurred      │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│            ▼                                                                   │
│  ┌─────────────────┐                                                           │
│  │ Exception Type  │                                                           │
│  │ Detection       │                                                           │
│  └─────────┬───────┘                                                           │
│            │                                                                   │
│    ┌───────┼───────┬───────┬───────┬───────┐                                   │
│    │       │       │       │       │       │                                   │
│    ▼       ▼       ▼       ▼       ▼       ▼                                   │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                               │
│ │Token│ │Action│ │Perm-│ │Valid│ │System│ │Other│                               │
│ │Error│ │Error│ │ission│ │ation│ │Error│ │Error│                               │
│ │     │ │     │ │Error│ │Error│ │     │ │     │                               │
│ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘ └──┬──┘                               │
│    │       │       │       │       │       │                                   │
│    ▼       ▼       ▼       ▼       ▼       ▼                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐   │
│ │                    Error Response Formatter                             │   │
│ │                                                                         │   │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│ │  │ 401 Unauthorized│  │ 403 Forbidden   │  │ 404 Not Found   │         │   │
│ │  │                 │  │                 │  │                 │         │   │
│ │  │ • UNAUTHORIZED  │  │ • INSUFFICIENT_ │  │ • ACTION_NOT_   │         │   │
│ │  │ • Invalid Token │  │   PERMISSIONS   │  │   FOUND         │         │   │
│ │  │ • Expired Token │  │ • ACTION_       │  │ • Invalid Action│         │   │
│ │  └─────────────────┘  │   DISABLED      │  │   Type          │         │   │
│ │                       └─────────────────┘  └─────────────────┘         │   │
│ │                                                                         │   │
│ │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│ │  │ 422 Validation  │  │ 500 Server Error│  │ Custom Errors   │         │   │
│ │  │ Error           │  │                 │  │                 │         │   │
│ │  │                 │  │ • INTERNAL_     │  │ • Business Logic│         │   │
│ │  │ • VALIDATION_   │  │   SERVER_ERROR  │  │   Errors        │         │   │
│ │  │   ERROR         │  │ • System        │  │ • Custom        │         │   │
│ │  │ • Field Errors  │  │   Exceptions    │  │   Exceptions    │         │   │
│ │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│ └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Logging System                                   │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │ Error Logging   │  │ Permission      │  │ Audit Logging   │         │   │
│  │  │                 │  │ Logging         │  │                 │         │   │
│  │  │ • Exception     │  │                 │  │ • API Access    │         │   │
│  │  │   Details       │  │ • Permission    │  │ • User Actions  │         │   │
│  │  │ • Stack Trace   │  │   Denied        │  │ • System Events │         │   │
│  │  │ • Request Info  │  │ • User Info     │  │                 │         │   │
│  │  └─────────────────┘  │ • Action Info   │  └─────────────────┘         │   │
│  │                       └─────────────────┘                              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                           │
│                                    ▼                                           │
│  ┌─────────────────┐                                                           │
│  │ JSON Response   │                                                           │
│  │ to Client       │                                                           │
│  └─────────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

這些架構文檔提供了權限系統的完整技術視圖，包括：

1. **系統架構概覽** - 展示所有組件如何協同工作
2. **資料模型關係** - 說明資料庫表之間的關係
3. **權限檢查流程** - 詳細的權限驗證步驟
4. **權限決策樹** - 權限判斷的邏輯分支
5. **服務依賴關係** - 各服務之間的依賴關係
6. **初始化流程** - 系統啟動時的初始化步驟
7. **錯誤處理流程** - 異常情況的處理機制

這些圖表可以幫助開發者更好地理解系統架構，進行維護和擴展。